import React, { useState, useEffect } from "react";
import { Box, Flex, Text, Image } from "@chakra-ui/react";
import { useLocation } from "react-router-dom";

import BottomBoardList from "../../components/game/BottomBoardList";

import BackgroundImg from "../../images/game_background.webp";
import ScoreBoard from "../../components/game/ScoreBoard";
import Dish from "../../components/game/Dish";

export default function Game() {
    const location = useLocation();
    const queryParams = new URLSearchParams(location.search);
    const name = queryParams.get("name");
    const phone = queryParams.get("phone");
    
    const [score, setScore] = useState(0);
    const [time, setTime] = useState(30);
    const [isLandscape, setIsLandscape] = useState(window.innerWidth > window.innerHeight);
    const [countdown, setCountdown] = useState(3);
    const [gameStarted, setGameStarted] = useState(false);
    const [gameFinished, setGameFinished] = useState(false);

    // Í∞Å ÏöîÎ¶¨Ïóê Îì§Ïñ¥Í∞Ñ Ïû¨Î£å Ïàò
    const [dishStatus, setDishStatus] = useState([0, 0, 0]);
    // ÌòÑÏû¨ Í∑∏Î¶á Ïù∏Îç±Ïä§
    const [dishIndex, setDishIndex] = useState(0);
    // Í∞Å Í∑∏Î¶áÏùò ÏûÑÏãú Ï†êÏàò
    const [dishScore, setDishScore] = useState([0, 0, 0]);

    // ÏÑ†ÌÉùÎêú Ïû¨Î£åÎì§ÏùÑ Ï†ÄÏû•ÌïòÎäî state
    const [selectedIngredients, setSelectedIngredients] = useState([]);

    // Îß§Î≤à ÏÑûÏûÑ
    const [ingredients, setIngredients] = useState({
        1: "egg",
        2: "flake",
        3: "green_onion",
        4: "water",
        5: "noodle",
        6: "soup"
    });

    // ingredientsÎ•º ÏÑûÏñ¥Ï£ºÎäî Ìï®Ïàò
    const shuffleIngredients = () => {
        const ingredientArray = Object.values(ingredients);
        for (let i = ingredientArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [ingredientArray[i], ingredientArray[j]] = [ingredientArray[j], ingredientArray[i]];
        }
        const shuffledIngredients = ingredientArray.reduce((acc, ingredient, index) => {
            acc[index + 1] = ingredient;
            return acc;
        }, {});
        setIngredients(shuffledIngredients);
    };

    // ÌôîÎ©¥ Î∞©Ìñ• Í∞êÏßÄ Ìï®Ïàò
    const checkOrientation = () => {
        setIsLandscape(window.innerWidth > window.innerHeight);
    };

    // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ï≤òÏùå Î†åÎçîÎßÅÎê† Îïå shuffleIngredients Ìï®ÏàòÎ•º Ìïú Î≤à Ïã§Ìñâ
    useEffect(() => {
        shuffleIngredients();
        checkOrientation();
        window.addEventListener('resize', checkOrientation);
        return () => window.removeEventListener('resize', checkOrientation);
    }, []);

    // Ïπ¥Ïö¥Ìä∏Îã§Ïö¥ Ìö®Í≥º
    useEffect(() => {
        if (isLandscape && countdown > 0) {
            const timer = setInterval(() => {
                setCountdown(prev => {
                    if (prev > 1) {
                        return prev - 1;
                    } else {
                        clearInterval(timer);
                        setCountdown(0);
                        setTimeout(() => setGameStarted(true), 1000);
                        return 0;
                    }
                });
            }, 1000);
        
            return () => clearInterval(timer);
        }
    }, [isLandscape, countdown]);

    // timeÏùÑ Îß§Ï¥àÎßàÎã§ 1Ïî© Ï§ÑÏù¥Îäî useEffect, isLandscapeÍ∞Ä falseÏùº ÎïåÎäî ÌÉÄÏù¥Î®∏Î•º Î©àÏ∂§
    useEffect(() => {
        let timer;
        if (isLandscape && gameStarted && time > 0) {
            timer = setInterval(() => {
                setTime(prevTime => {
                    if (prevTime > 1) {
                        return prevTime - 1;
                    } else {
                        clearInterval(timer);
                        setGameFinished(true);

                        
                        return 0;
                    }
                });
            }, 1000);
        }

        // Ïª¥Ìè¨ÎÑåÌä∏Í∞Ä Ïñ∏ÎßàÏö¥Ìä∏ÎêòÍ±∞ÎÇò ÏùòÏ°¥ÏÑ±Ïù¥ Î≥ÄÍ≤ΩÎê† Îïå ÌÉÄÏù¥Î®∏Î•º Ï†ïÎ¶¨
        return () => {
            if (timer) {
                clearInterval(timer);
            }
        };
    }, [isLandscape, gameStarted, time]);

    if (!isLandscape) {
        return (
            <Flex
                height="100vh"
                justifyContent="center"
                alignItems="center"
                backgroundColor="rgba(0,0,0,0.8)"
                color="white"
                flexDirection="column"
            >
                <Text fontSize="24px" fontWeight="bold" mb="20px">
                    ÌôîÎ©¥ÏùÑ Í∞ÄÎ°úÎ°ú ÎèåÎ†§Ï£ºÏÑ∏Ïöî
                </Text>
                <Box transform="rotate(90deg)">
                    <span role="img" aria-label="rotate phone" style={{ fontSize: '48px' }}>
                        üì±
                    </span>
                </Box>
            </Flex>
        );
    }

    return (
        <Flex
            backgroundImage={`url(${BackgroundImg})`}
            backgroundSize="cover"
            backgroundPosition="center"
            height="100vh"
            justifyContent="center"
            position="relative"
        >
            {!gameStarted && (
                <Flex
                    position="absolute"
                    top="0"
                    left="0"
                    right="0"
                    bottom="0"
                    backgroundColor="rgba(0,0,0,0.7)"
                    justifyContent="center"
                    alignItems="center"
                    zIndex="10"
                >
                    <Text fontSize="96px" fontWeight="bold" color="white">
                        {countdown === 0 ? "GO!" : countdown}
                    </Text>
                </Flex>
            )}
            {gameFinished && (
                <Flex
                    position="absolute"
                    top="0"
                    left="0"
                    right="0"
                    bottom="0"
                    backgroundColor="rgba(0,0,0,0.7)"
                    justifyContent="center"
                    alignItems="center"
                    zIndex="10"
                >
                    <Text fontSize="96px" fontWeight="bold" color="white">
                        Finish!
                    </Text>
                </Flex>
            )}
            <Box height="100%">
                <Flex justifyContent="center" gap="16px" mt="15px">
                    <ScoreBoard text={name} />
                    <ScoreBoard text={`${time}Ï¥à`} />
                    <ScoreBoard text={`${score}Ï†ê`} />
                </Flex>

                <Flex justifyContent="space-around">
                    {dishStatus.map((status, index) => (
                        <Dish
                            key={index}
                            id={index}
                            dish={status}
                            score={score}
                            setScore={setScore}
                            addScore={dishScore[index]}
                            dishScore={dishScore}
                            setDishScore={setDishScore}
                            dishStatus={dishStatus}
                            setDishStatus={setDishStatus}
                        />
                    ))}
                </Flex>
                <Box position="absolute" bottom="0px">
                    <BottomBoardList
                        ingredients={ingredients}
                        selectedIngredients={selectedIngredients}
                        setSelectedIngredients={setSelectedIngredients}
                        dishStatus={dishStatus}
                        setDishStatus={setDishStatus}
                        dishIndex={dishIndex}
                        setDishIndex={setDishIndex}
                        shuffleIngredients={shuffleIngredients}
                        dishScore={dishScore}
                        setDishScore={setDishScore}
                    />
                </Box>
            </Box>
        </Flex>
    );
}